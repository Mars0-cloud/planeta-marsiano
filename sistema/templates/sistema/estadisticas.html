{% extends "sistema/base.html" %}
{% load static %}
{% block title %}Estadísticas - Planeta Marsiano{% endblock %}

{% block contenido %}
<div class="container mt-5 pt-5">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card text-white" style="background: linear-gradient(135deg, #50ae5d 0%, #1c1c1c 100%);">
                <div class="card-body text-center">
                    <h1 class="card-title mb-3">
                        <i class="fas fa-chart-line me-3"></i>Estadísticas de la Biblioteca
                    </h1>
                    <p class="card-text fs-5">
                        Análisis detallado de {{ total_peliculas }} películas en Planeta Marsiano
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Estadísticas principales -->
    <div class="row mb-5">
        <div class="col-lg-3 col-md-6 mb-4">
            <div class="stats-card text-center p-4">
                <i class="fas fa-film fa-3x text-primary mb-3"></i>
                <h2 class="display-5 fw-bold text-primary">{{ total_peliculas }}</h2>
                <p class="text-muted fs-6">Películas Totales</p>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-4">
            <div class="stats-card text-center p-4">
                <i class="fas fa-star fa-3x text-warning mb-3"></i>
                <h2 class="display-5 fw-bold text-warning">{{ ratings_stats.promedio|floatformat:2 }}</h2>
                <p class="text-muted fs-6">Rating Promedio</p>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-4">
            <div class="stats-card text-center p-4">
                <i class="fas fa-crown fa-3x text-danger mb-3"></i>
                <h2 class="display-5 fw-bold text-danger">{{ ratings_counts.cinco_estrellas }}</h2>
                <p class="text-muted fs-6">Películas de 5⭐</p>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-4">
            <div class="stats-card text-center p-4">
                <i class="fas fa-masks-theater fa-3x text-info mb-3"></i>
                <h2 class="display-5 fw-bold text-info">{{ top_genres|length }}</h2>
                <p class="text-muted fs-6">Géneros Diferentes</p>
            </div>
        </div>
    </div>

    <!-- Gráficos -->
    <div class="row mb-5">
        <div class="col-lg-6 mb-4">
            <div class="card shadow">
                <div class="card-header bg-dark text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-star-half-alt me-2"></i>Distribución de Ratings
                    </h4>
                </div>
                <div class="card-body">
                    <canvas id="ratingsChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-lg-6 mb-4">
            <div class="card shadow">
                <div class="card-header bg-dark text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-tags me-2"></i>Top Géneros
                    </h4>
                </div>
                <div class="card-body">
                    <canvas id="genresChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-5">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header bg-dark text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-history me-2"></i>Películas por Década
                    </h4>
                </div>
                <div class="card-body">
                    <canvas id="decadesChart"></canvas>
                    <div class="row mt-4">
                        {% for decade, stats in decades_stats.items %}
                        <div class="col-lg-3 col-md-6 mb-3">
                            <div class="decade-card text-center p-3">
                                <h5 class="fw-bold text-primary">{{ decade }}</h5>
                                <div><strong>{{ stats.count }}</strong> películas</div>
                                <div><small class="text-muted">Promedio: {{ stats.avg_rating }}⭐</small></div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<script>
// JSON seguro
const ratingsData = JSON.parse('{{ ratings_chart_data|escapejs }}');
const genresData = JSON.parse('{{ genres_chart_data|escapejs }}');
const decadesData = JSON.parse('{{ decades_chart_data|escapejs }}');

// Gráfico de ratings
const ratingsChart = new Chart(document.getElementById('ratingsChart'), {
    type: 'doughnut',
    data: {
        labels: ratingsData.labels.map(label => label + '⭐'),
        datasets: [{
            data: ratingsData.data,
            backgroundColor: ratingsData.data.map((_, i) => ['#28a745','#20c997','#17a2b8','#ffc107','#fd7e14','#dc3545'][i % 6]),
            borderWidth: 2,
            borderColor: '#fff'
        }]
    },
    options: { responsive: true, plugins: { legend: { position: 'bottom', labels: { padding: 20, usePointStyle: true } } } }
});

// Gráfico de géneros
const genresChart = new Chart(document.getElementById('genresChart'), {
    type: 'bar',
    data: {
        labels: genresData.labels,
        datasets: [{
            label: 'Películas',
            data: genresData.data,
            backgroundColor: 'rgba(80, 174, 93, 0.8)',
            borderColor: 'rgba(80, 174, 93, 1)',
            borderWidth: 1
        }]
    },
    options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
});

// Gráfico de décadas
const decadesChart = new Chart(document.getElementById('decadesChart'), {
    type: 'line',
    data: {
        labels: decadesData.labels,
        datasets: [{
            label: 'Número de Películas',
            data: decadesData.counts,
            borderColor: 'rgba(80, 174, 93, 1)',
            backgroundColor: 'rgba(80, 174, 93, 0.1)',
            fill: true,
            tension: 0.4
        }]
    },
    options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
});
</script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
{% endblock %}
